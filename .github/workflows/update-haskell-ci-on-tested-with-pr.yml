name: Update Haskell CI when PR updates .cabal file and its title starts with "tested-with"

on:
  pull_request:
    # Fire for typical PR lifecycle events
    types: [opened, reopened]
    # Only run when the specified file(s) are part of the PR diff.
    # CHANGE THIS to the path(s) you care about (supports globs).
    paths:
      - '**/*.cabal'

permissions:
  contents: write
  pull-requests: write
  workflows: write  # allow committing changes to .github/workflows/*

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  gate:
    runs-on: ubuntu-latest
    outputs:
      eligible: ${{ steps.gate.outputs.eligible }}
    steps:
      - name: Decide eligibility (title starts with tested-with, same-repo PR)
        id: gate
        shell: bash
        run: |
          set -euo pipefail
          # Read and sanitize the PR title (handles quotes)
          title=${{ toJSON(github.event.pull_request.title) }}
          title=${title#\"}; title=${title%\"}
          head_repo="${{ github.event.pull_request.head.repo.full_name }}"
          base_repo="${{ github.repository }}"

          title_ok=false
          if printf '%s' "$title" | grep -qiE '^tested-with'; then
            title_ok=true
          fi

          same_repo=false
          if [ "$head_repo" = "$base_repo" ]; then
            same_repo=true
          fi

          eligible=false
          if [ "$title_ok" = true ] && [ "$same_repo" = true ]; then
            eligible=true
          fi

          echo "Eligibility: title_ok=$title_ok, same_repo=$same_repo, eligible=$eligible"
          echo "eligible=$eligible" >> "$GITHUB_OUTPUT"


  update-ci:
    needs: gate
    if: needs.gate.outputs.eligible == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Check out PR branch
        uses: actions/checkout@v4
        with:
          # Checkout the PR head branch so we can commit back to it
          ref: ${{ github.head_ref }}

      # Haskell-specific: install haskell-ci from source and regenerate workflows
      - name: Set up Haskell toolchain
        uses: haskell-actions/setup@v2

      - name: Clone haskell-ci sources
        shell: bash
        run: |
          set -euxo pipefail
          git clone --depth 1 https://github.com/haskell-CI/haskell-ci.git .tooling/haskell-ci

      # Cache Cabal store and haskell-ci build artifacts
      - name: Cache Cabal store and dist-newstyle for haskell-ci
        uses: actions/cache@v4
        with:
          path: |
            ~/.cabal/store
            .tooling/haskell-ci/dist-newstyle
          key: ${{ runner.os }}-cabalstore-ghc-${{ env.GHC_VERSION }}-cabal-${{ env.CABAL_VERSION }}-${{ hashFiles('.tooling/haskell-ci/**/*.cabal', '.tooling/haskell-ci/cabal.project*') }}
          restore-keys: |
            ${{ runner.os }}-cabalstore-ghc-${{ env.GHC_VERSION }}-cabal-${{ env.CABAL_VERSION }}-

      - name: Build and install haskell-ci
        shell: bash
        run: |
          set -euxo pipefail
          cd .tooling/haskell-ci
          cabal update
          cabal build exe:haskell-ci
          cabal install exe:haskell-ci --overwrite-policy=always --installdir="$HOME/.local/bin" --install-method=copy
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

      - name: Regenerate workflows with haskell-ci
        run: |
          set -euxo pipefail
          haskell-ci regenerate

      - name: Commit changes back to PR branch
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(ci): regenerate CI from tested-with PR"
          branch: ${{ github.head_ref }}
          # Limit to the typical files haskell-ci may edit
          file_pattern: |
            .github/workflows/**
            .haskell-ci
